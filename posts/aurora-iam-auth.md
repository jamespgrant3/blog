---
layout: post
title: aurora iam authentication
tags: [aws, iam, rds]
date: "2022-02-28"
---

Ever read the docs for authenticating using IAM for aurora? Specifically around IAM connect permissions? Like [this](https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/UsingWithRDS.IAMDBAuth.IAMPolicy.html) blog post, or [this](https://aws.amazon.com/premiumsupport/knowledge-center/rds-postgresql-connect-using-iam/) one, or [this](https://catalog.us-east-1.prod.workshops.aws/workshops/2a5fc82d-2b5f-4105-83c2-91a1b4d7abfe/en-US/2-foundation/lab8-dbatasks/task1) one.

You'll find that they all say you just have to provide `rds-db:connect` with the appropriate `resource`, and you can connect. Well, my experience was not that easy.

To get a full picture, let's walk through the steps I took. First, I had already enabled IAM authentication on the cluster via terraform. Next, I created a database user:

```sql
CREATE USER iam_rds_poc WITH LOGIN;
GRANT rds_iam TO iam_rds_poc;
```

Next, I used the cli to find the cluster resource id, because it's not available in the aws console:

```sh
aws rds describe-db-clusters \
--db-cluster-identifier <enter-identifier-here> \
--query "DBClusters[0].DbClusterResourceId"
```

With this, I was ready to create my IAM policy, just as all the docs say to do:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["rds-db:connect"],
      "Resource": [
        "arn:aws:rds-db:us-east-1:<account-id>:dbuser:<cluster-identifier>/iam_rds_poc"
      ]
    }
  ]
}
```

I quickly attached that policy to my `test` user, and started to generate the ole token:

```
export RDSHOST="<cluster-host-url>"
export DBPASSWORD="$(aws rds generate-db-auth-token --hostname $RDSHOST --port 5432 --region us-east-1 --username iam_rds_poc)"
echo $DBPASSWORD | pbcopy
```

When I would connect, using the provided password, I would get the following error: `PAM authentication failed for your user`

It's important to understand, the token provided is generated by the aws credentials. In this case, I was a user, with only `rds-db:connect`. So, to rule out IAM, I exported credentials to a user who has god mode, available to do all actions, to all resources. Guess, what, IT WORKED! I was able to successfully connect to the database.

So, `rds-db:connect` was **NOT** enough. So, knowing I was doing database things, I re-exported the credentials for my `test` user....and updated the permissions:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["rds-db:connect", "rds:*"],
      "Resource": [
        "arn:aws:rds-db:us-east-1:<account-id>:dbuser:<cluster-identifier>/iam_rds_poc"
      ]
    }
  ]
}
```

And it worked!! But, clearly this is very permissive. So, I read through the rds iam action [docs](https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazonrds.html). I was looking for patterns in the read permissions. I found that most read actions were prefixed with `List` and `Describe`. Again, `List` felt very permissive. So I updated the policy like so:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["rds-db:connect", "rds:Describe*"],
      "Resource": [
        "arn:aws:rds-db:us-east-1:<account-id>:dbuser:<cluster-identifier>/iam_rds_poc"
      ]
    }
  ]
}
```

And again, it worked. I left it here. I sunk several hours into this. One day, I plan to determine what `Describe` permissions are actually necessary.

Also, unsure why, but I have only been able to connect using the `psql` on the command, or PGAdmin. Other tools like Postico or TablePlus will not allow me to connect. More research at a later date.
