---
title: "s3 malware protection"
tags: [aws, s3, guardduty]
date: "2024-06-12"
---
# problem overview

Today, we were supposed to start a sprint to rewrite our file upload process. Currently, we're dependent on a service called [filestack](https://www.filestack.com).

The service provides some really nice features: an attractive upload UI, multi-file uploads, and provides five 9's of reliability. Our implementation uploaded to s3. I didn't like that we couldn't use roles for permissioning, we had to create a user and provide filestack with access keys.

The biggest problem though, was this is yet another dependency and more importantly our files are flowing through an external vendor.

### current implementation

Upon upload, filestack uploaded to a bucket, a lambda would then fire and move the file to another bucket that the service did not have permissions to.

### feature request

We were to implement a custom UI, and additionally conduct malware scans. I want to talk about the latter, malware scanning. During our planning session, we planned on tackling the scanning with a container running [clamav](https://www.clamav.net/).

Last night, I ran into [this](https://aws.amazon.com/about-aws/whats-new/2024/06/detect-malware-object-uploads-amazon-s3-guardduty/) article. GuardDuty now allows for s3 malware scanning! Insane timing!! Our sprint started with a POC on this new feature.

### s3 malware scanning highlights

- upon an upload to s3, GuardDuty pulls the file off into an isolated environment using PrivateLink, decrypts the file, performs the scan, and deletes the file from the isolated environment.
- [results can be received](https://docs.aws.amazon.com/guardduty/latest/ug/how-malware-protection-for-s3-gdu-works.html#s3-malware-protection-capability) in several ways: a tag on the s3 file, an EventBridge notification, or a CloudWatch metric.
- up to 5 prefixes can be provided to limit what gets scanned in a bucket.

### new implementation

From a backend perspective, the only real change was the scanning of the file before it gets moved by the lambda. Here are the changes we made:

- enabled EventBridge notifications on the s3 bucket
- enabled Malware Protection for S3 in GuardDuty
- setup an EventBridge rule that receives the notification after a scan
- updated the lambda that moves the file to take in the event from EventBridge
- created a quarantine bucket for infected files

It's worth noting that initially neither Terraform or CloudFormation supported enabling malware protection in GuardDuty. However Terraform added support in version [5.54.0](https://registry.terraform.io/providers/hashicorp/aws/5.54.0/docs/resources/guardduty_malware_protection_plan), and [CloudFormation](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-guardduty-malwareprotectionplan.html) has also added support.

Also, the quarantine bucket did not contain the infected file, instead we wrote a json file that consisted of the EventBridge notification data.

### testing

Testing was pretty straightforward. You can download "fake" infected files by doing a quick google search. In cases where the service should find infected files it did.

We have a max upload file size of 15MB on the frontend, but to test the services performance I threw a 25MB file at it. From the timestamp of the file being uploaded to the time the lambda fired after the scan it clocked in at just under a second. In my opinion, that's pretty remarkable. During that time, an isolated environment was created, the file was pulled in, the scan occurred, an EventBridge notification was sent, and a Lambda was triggered!

### pricing

Existing AWS accounts are covered under a free-tier for 12 months after the feature is released, so until June 12, 2025. New AWS accounts opened after the feature was released (June 11, 2024), then the trial period will be the same as the 12-month free tier period of the account.

The free-tier includes 1k free requests and 1GB of scans per month.

After the free-tier, for us-east-1, you are billed .60 per GB of files scanned and .215 per 1k objects scanned. If you enable tagging you will also be billed .01 per 10k tags per month

### links

[GuardDuty Malware Protection for S3](https://docs.aws.amazon.com/guardduty/latest/ug/gdu-malware-protection-s3.html)

### nice-to-haves

It'd be nice if we could run scans during the download process, to ensure there are no malware findings since the file was uploaded. There could have been an update applied to the malware definitions after the file was uploaded.
